{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/mypage/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/coffeechat/list.css' %}">

<div class="profile-container">
    <div class="profile-header">
        <div class="profile-image">
            {% if profile and profile.profile_image %}
                <img src="{{ profile.profile_image.url }}" alt="{{ user.username }}ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€">
            {% else %}
                {% if user.profile_image %}
                    <img src="{{ user.profile_image.url }}" alt="Profile Image">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
            {% endif %}
        </div>
        <div class="profile-info">
            <h1>ğŸ€{{ user.cohort }}ê¸° í”¼ë¡œê·¸ë˜ë¨¸ {{ user.username }}ğŸ€</h1>
            <p>{{ profile.intro|default_if_none:"ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤." }}</p>
        </div>
    </div>

    <div class="profile-activities">
        <div class="activity-filter" id="activity-filter">
            <a href="#" class="filter-link active" data-category="all">All</a>
            <a href="#" class="filter-link" data-category="review">review</a>
            <a href="#" class="filter-link" data-category="corboard">cooperation</a>
            <a href="#" class="filter-link" data-category="trend">ITtrend</a>
        </div>

        <div class="activity-content-wrapper">
            <div class="activity-navbar">
                <a href="#" class="activity-link active" data-filter="my_posts">ë‚´ê°€ ì“´ ê¸€</a>
                <a href="#" class="activity-link" data-filter="bookmarked">ë¶ë§ˆí¬í•œ ê¸€</a>
                <a href="#" class="activity-link" data-filter="liked">ì¢‹ì•„ìš”í•œ ê¸€</a>
                <a href="#" class="activity-link" data-filter="commented">ëŒ“ê¸€ ë‹¨ ê¸€</a>
                <a href="#" class="activity-link" data-filter="coffeechat">ì»¤í”¼ì±—</a>
                <a href="#" class="activity-link" data-filter="profile_info">ë‚´ ì •ë³´</a>
            </div>

            <div id="activity-content" class="activity-content">
                <!-- AJAX -->
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentFilter = 'my_posts';
        let currentCategory = 'all';
        const originalFilterContent = document.getElementById('activity-filter').innerHTML;
    
        function addFilterEventListeners() {
            const filterLinks = document.querySelectorAll('.filter-link');
            filterLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentCategory = this.getAttribute('data-category');
                    filterLinks.forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                    loadActivities(currentFilter, currentCategory);
                });
            });
        }
    
        function loadActivities(filter, category) {
            const url = `{% url 'mypage:ajax_activities' %}?filter=` + filter + `&category=` + category;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const activityContent = document.getElementById('activity-content');
                    activityContent.innerHTML = '';
    
                    if (filter === 'profile_info') {
                        const profileInfo = `
                            <div class="profile-info-card">
                                <p><strong>ì‚¬ìš©ì ì´ë¦„:</strong> ${data.username}</p>
                                <p><strong>ì´ë©”ì¼ ì£¼ì†Œ:</strong> ${data.email}</p>
                                <p><strong>ë‹‰ë„¤ì„:</strong> ${data.nickname}</p>
                                <p><strong>ê¸°ìˆ˜:</strong> ${data.cohort}</p>
                                <p><strong>ì†Œê°œ:</strong> ${data.intro}</p>
                                ${data.profile_image ? `<img src="${data.profile_image}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">` : ''}
                                <a href="{% url 'mypage:profile_edit' %}" class="btn btn-primary">í”„ë¡œí•„ ìˆ˜ì •</a>
                            </div>
                        `;
                        activityContent.innerHTML = profileInfo;
                    } else if (filter === 'coffeechat') {
                        if (category === 'requests_sent' && data.requests_sent) {
                            data.requests_sent.forEach(request => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
                                const requestElement = `
                                    <div class="coffeechat-card">
                                        <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                        <div class="card-content">
                                            <div class="profile-img">
                                                {% if request.profile_image %}
                                                    <img src="{{ request.profile_image.url }}" alt="Profile Image">
                                                {% else %}
                                                    <i class="fas fa-user"></i>
                                                {% endif %}
                                            </div>
                                            <p>ë°›ëŠ” ì‚¬ëŒ: ${request.receiver}</p>
                                            <span>ì§ì—…: ${request.job}</span><br>
                                            <span>ìš”ì²­ ì‹œê°„: ${new Date(request.created_at).toLocaleString()}</span><br>
                                            <span>ìƒíƒœ: ${request.status}</span>
                                        </div>
                                    </div>
                                `;
                                activityContent.innerHTML += requestElement;
                            });
                        } else if (category === 'requests_received' && data.requests_received) {
                            data.requests_received.forEach(request => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
                                const requestElement = `
                                    <div class="coffeechat-card">
                                        <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                        <div class="card-content">
                                            <div class="profile-img">
                                                {% if request.profile_image %}
                                                    <img src="{{ request.profile_image.url }}" alt="Profile Image">
                                                {% else %}
                                                    <i class="fas fa-user"></i>
                                                {% endif %}
                                            </div>
                                            <p>ë³´ë‚¸ ì‚¬ëŒ: ${request.sender}</p>
                                            <span>ì§ì—…: ${request.job}</span><br>
                                            <span>ìš”ì²­ ì‹œê°„: ${new Date(request.created_at).toLocaleString()}</span><br>
                                            <span>ìƒíƒœ: ${request.status}</span>
                                            <div class="buttons">
                                                <form method="post" action="${request.accept_url}">
                                                    {% csrf_token %}
                                                    <button type="submit">Accept</button>
                                                </form>
                                                <form method="post" action="${request.reject_url}">
                                                    {% csrf_token %}
                                                    <button class="reject" type="submit">Reject</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                activityContent.innerHTML += requestElement;
                            });
                        } else if (category === 'bookmarked' && data.bookmarked_coffeechats) {
                            data.bookmarked_coffeechats.forEach(coffeechat => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
                                const coffeechatElement = `
                                    <div class="coffeechat-card">
                                        <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                        <div class="card-content">
                                            <div class="profile-img">
                                                {% if coffeechat.profile_image %}
                                                    <img src="{{ coffeechat.profile_image.url }}" alt="Profile Image">
                                                {% else %}
                                                    <i class="fas fa-user"></i>
                                                {% endif %}
                                            </div>
                                            <p>ë°›ëŠ” ì‚¬ëŒ: ${coffeechat.receiver}</p>
                                            <span>ì§ì—…: ${coffeechat.job}</span><br>
                                            <span>ìš”ì²­ ì‹œê°„: ${new Date(coffeechat.created_at).toLocaleString()}</span><br>
                                            <span>ë‚´ìš©: ${coffeechat.content}</span>
                                        </div>
                                    </div>
                                `;
                                activityContent.innerHTML += coffeechatElement;
                            });
                        } else if (category === 'history' && data.accepted_requests) {
                            data.accepted_requests.forEach(request => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
                                const requestElement = `
                                    <div class="coffeechat-card">
                                        <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                        <div class="card-content">
                                            <div class="profile-img">
                                                {% if request.profile_image %}
                                                    <img src="{{ request.profile_image.url }}" alt="Profile Image">
                                                {% else %}
                                                    <i class="fas fa-user"></i>
                                                {% endif %}
                                            </div>
                                            <p>ë³´ë‚¸ ì‚¬ëŒ: ${request.sender}</p>
                                            <span>ì§ì—…: ${request.job}</span><br>
                                            <span>ìš”ì²­ ì‹œê°„: ${new Date(request.created_at).toLocaleString()}</span><br>
                                            <span>ìƒíƒœ: ${request.status}</span>
                                            ${request.review ? `
                                                <div class="review">
                                                    <p><strong>ë¦¬ë·°:</strong></p>
                                                    <p>í‰ì : ${request.review.rating}</p>
                                                    <p>ë‚´ìš©: ${request.review.content}</p>
                                                    <p>ë¦¬ë·° ì‘ì„± ì‹œê°„: ${new Date(request.review.created_at).toLocaleString()}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                                activityContent.innerHTML += requestElement;
                            });
                        }
                    } else {
                        if (data.posts && data.posts.length > 0) {
                            data.posts.forEach(post => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
                        
                                const postElement = document.createElement('div');
                                postElement.classList.add('activity-card');
                                postElement.innerHTML = `
                                    <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                    <div class="card-content">
                                        <h3><a href="${post.url}">${post.title}</a></h3>
                                        <span>ì‘ì„±ì: ${post.writer}</span><br>
                                        <span>ë‚ ì§œ: ${new Date(post.date).toLocaleDateString()}</span>
                                    </div>
                                `;
                                activityContent.appendChild(postElement);
                            });
                        } else {
                            activityContent.innerHTML = '<p>í•´ë‹¹í•˜ëŠ” ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    }
                })
                .catch(error => console.error('Error loading activities:', error));
        }
    
        function addActivityLinkEventListeners() {
            const activityLinks = document.querySelectorAll('.activity-link');
            activityLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentFilter = this.getAttribute('data-filter');
                    activityLinks.forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ì»¤í”¼ì±— í•„í„°ë¥¼ ì„ íƒí–ˆì„ ë•Œ í•„í„° ë³€ê²½
                    if (currentFilter === 'coffeechat') {
                        document.querySelector('.activity-filter').innerHTML = `
                            <a href="#" class="filter-link active" data-category="requests_sent">Sent</a>
                            <a href="#" class="filter-link" data-category="requests_received">Received</a>
                            <a href="#" class="filter-link" data-category="bookmarked">Interested</a>
                            <a href="#" class="filter-link" data-category="history">History</a>
                        `;
                        addFilterEventListeners();
                        loadActivities(currentFilter, 'requests_sent');
                    } else {
                        document.querySelector('.activity-filter').innerHTML = originalFilterContent;
                        addFilterEventListeners();
                        loadActivities(currentFilter, currentCategory);
                    }
                });
            });
        }
    
        // ì´ˆê¸° ë¡œë”© ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
        loadActivities(currentFilter, currentCategory);
    
        addActivityLinkEventListeners();
        addFilterEventListeners();
    });
</script>
{% endblock %}