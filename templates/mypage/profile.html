{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/mypage/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/mypage/mobile.css' %}">
<div class="profile-container">
    <div class="profile-header">
        <div class="profile-image">
            {% if profile and profile.profile_image %}
                <img src="{{ profile.profile_image.url }}" alt="{{ user.username }}ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€">
            {% else %}
                {% if user.profile_image %}
                    <img src="{{ user.profile_image.url }}" alt="Profile Image">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
            {% endif %}
        </div>
        <div class="profile-info">
            <h1>ğŸ€{{ user.cohort }}ê¸° í”¼ë¡œê·¸ë˜ë¨¸ {{ user.username }}ğŸ€</h1>
            <p>{{ profile.intro|default_if_none:"ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤." }}</p>
        </div>
    </div>

    <div class="profile-activities">
        <div class="activity-filter" id="activity-filter">
            <a href="#" class="filter-link active" data-category="all">All</a>
            <a href="#" class="filter-link" data-category="review">review</a>
            <a href="#" class="filter-link" data-category="corboard">cooperation</a>
            <a href="#" class="filter-link" data-category="trend">ITtrend</a>
        </div>

        <div class="activity-content-wrapper">
            <div class="activity-navbar desktop">
                <a href="#" class="activity-link active" data-filter="my_posts">ë‚´ê°€ ì“´ ê¸€</a>
                <a href="#" class="activity-link" data-filter="bookmarked">ë¶ë§ˆí¬í•œ ê¸€</a>
                <a href="#" class="activity-link" data-filter="liked">ì¢‹ì•„ìš”í•œ ê¸€</a>
                <a href="#" class="activity-link" data-filter="commented">ëŒ“ê¸€ ë‹¨ ê¸€</a>
                <a href="#" class="activity-link" data-filter="coffeechat">ì»¤í”¼ì±—</a>
                <a href="#" class="activity-link" data-filter="profile_info">ë‚´ ì •ë³´</a>
            </div>
            
            <div class="activity-navbar mobile">
                <button id="navbar-toggle" class="navbar-toggle">
                    <span>ë‚´ê°€ ì“´ ê¸€</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <ul class="activity-list">
                    <li><a href="#" class="activity-link active" data-filter="my_posts">ë‚´ê°€ ì“´ ê¸€</a></li>
                    <li><a href="#" class="activity-link" data-filter="bookmarked">ë¶ë§ˆí¬í•œ ê¸€</a></li>
                    <li><a href="#" class="activity-link" data-filter="liked">ì¢‹ì•„ìš”í•œ ê¸€</a></li>
                    <li><a href="#" class="activity-link" data-filter="commented">ëŒ“ê¸€ ë‹¨ ê¸€</a></li>
                    <li><a href="#" class="activity-link" data-filter="coffeechat">ì»¤í”¼ì±—</a></li>
                    <li><a href="#" class="activity-link" data-filter="profile_info">ë‚´ ì •ë³´</a></li>
                </ul>
            </div>

            <div id="activity-content" class="activity-content">
                <!-- AJAX -->
            </div>
        </div>
    </div>
</div>
<!-- í•˜ë‹¨ì— ì¶”ê°€ëœ ê³ ì • ë„¤ë¹„ê²Œì´ì…˜ ë°”
<div class="bottom-navbar mobile">
    <a href="#" class="bottom-link" data-filter="my_posts"><i class="fas fa-heart"></i>ë‚´ê°€ ì“´ ê¸€</a>
    <a href="#" class="bottom-link" data-filter="bookmarked"><i class="fas fa-heart"></i>ë¶ë§ˆí¬í•œ ê¸€</a>
    <a href="#" class="bottom-link" data-filter="liked"><i class="fas fa-heart"></i>ì¢‹ì•„ìš”í•œ ê¸€</a>
    <a href="#" class="bottom-link" data-filter="commented"><i class="fas fa-heart"></i>ëŒ“ê¸€ ë‹¨ ê¸€</a>
    <a href="#" class="bottom-link" data-filter="coffeechat"><i class="fas fa-heart"></i>ì»¤í”¼ì±—</a>
    <a href="#" class="bottom-link" data-filter="profile_info"><i class="fas fa-heart"></i>ë‚´ ì •ë³´</a>
</div> -->

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const navbarToggle = document.getElementById('navbar-toggle');
        const activityList = document.querySelector('.activity-list');
        // const bottomNavbar = document.querySelector('.bottom-navbar');

        function checkScreenWidth() {
            const isMobile = window.innerWidth <= 768;

            // ëª¨ë°”ì¼ì—ì„œëŠ” ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ë³´ì´ê¸°, ë°ìŠ¤í¬íƒ‘ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelector('.activity-navbar.desktop').classList.toggle('hidden', isMobile);
            document.querySelector('.activity-navbar.mobile').classList.toggle('hidden', !isMobile);

            // í† ê¸€ ë²„íŠ¼ì´ í™”ë©´ì— ë³´ì´ì§€ ì•Šê±°ë‚˜ DOMì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ bottom-navbarë¥¼ ë³´ì´ê²Œ
            // if (!navbarToggle || !navbarToggle.offsetParent) {
            //     bottomNavbar.classList.add('active');
            // } else {
            //     bottomNavbar.classList.remove('active');
            // }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œì™€ ìœˆë„ìš° í¬ê¸° ì¡°ì • ì‹œì— í•¨ìˆ˜ í˜¸ì¶œ
        window.addEventListener('load', checkScreenWidth);
        window.addEventListener('resize', checkScreenWidth);

        // ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
        if (navbarToggle) {
            navbarToggle.addEventListener('click', function() {
                activityList.classList.toggle('active');
            });

            document.addEventListener('click', function(event) {
                if (!navbarToggle.contains(event.target) && !activityList.contains(event.target)) {
                    activityList.classList.remove('active');
                }
            });

            document.querySelectorAll('.activity-link').forEach(function(link) {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    navbarToggle.querySelector('span').textContent = this.textContent;
                    activityList.classList.remove('active');
                });
            });
        } else {
            bottomNavbar.classList.add('active');
        }

        //-------------------------------------------------

        let currentFilter = 'my_posts';
        let currentCategory = 'all';
        const originalFilterContent = document.getElementById('activity-filter').innerHTML;

        function addFilterEventListeners() {
            const filterLinks = document.querySelectorAll('.filter-link');
            filterLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentCategory = this.getAttribute('data-category');
                    filterLinks.forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                    loadActivities(currentFilter, currentCategory);
                });
            });
        }

        function loadActivities(filter, category) {
            const url = `{% url 'mypage:ajax_activities' %}?filter=` + filter + `&category=` + category;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const activityContent = document.getElementById('activity-content');
                    activityContent.innerHTML = '';

                    if (filter === 'profile_info') {
                        activityContent.classList.remove('grid-content');
                        activityContent.classList.add('centered-content');
                    } else {
                        activityContent.classList.remove('centered-content');
                        activityContent.classList.add('grid-content');
                    }

                    if (filter === 'profile_info') {
                        const profileInfo = `
                            <div class="myinfo">
                                <div class="myinfo-item">
                                    <strong>ì‚¬ìš©ì ì´ë¦„:</strong> {{ user.username }}
                                </div>
                                <div class="myinfo-item">
                                    <strong>ì´ë©”ì¼ ì£¼ì†Œ:</strong> {{ user.email }}
                                </div>
                                <div class="myinfo-item">
                                    <strong>ë‹‰ë„¤ì„:</strong> {{ user.nickname}}
                                </div>
                                <div class="myinfo-item">
                                    <strong>ê¸°ìˆ˜:</strong> {{ user.cohort}}
                                </div>
                                <div class="myinfo-item">
                                    <strong>ì†Œê°œ:</strong> {{ user.intro|default_if_none:'ìê¸°ì†Œê°œ ì—†ìŒ' }}
                                </div>
                                ${data.profile_image ? `<div class="myinfo-item"><img src="${data.profile_image}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image"></div>` : ''}
                                <a href="{% url 'mypage:profile_edit' %}" class="btn-primary">Edit</a>
                            </div>
                        `;
                        activityContent.innerHTML = profileInfo;
                    } else if (filter === 'coffeechat') {
                        let coffeechatCards = '';

                        if (category === 'requests_sent' && data.requests_sent) {
                            data.requests_sent.forEach(request => {
                                coffeechatCards += createCoffeeChatCard(request, 'sent');
                            });
                        } else if (category === 'requests_received' && data.requests_received) {
                            data.requests_received.forEach(request => {
                                coffeechatCards += createCoffeeChatCard(request, 'received');
                            });
                        } else if (category === 'bookmarked' && data.bookmarked_coffeechats) {
                            data.bookmarked_coffeechats.forEach(coffeechat => {
                                coffeechatCards += createCoffeeChatCard(coffeechat, 'bookmarked');
                            });
                        } else if (category === 'history' && data.accepted_requests) {
                            data.accepted_requests.forEach(request => {
                                coffeechatCards += createCoffeeChatCard(request, 'history');
                            });
                        } else {
                            coffeechatCards = '<p>í•´ë‹¹í•˜ëŠ” ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }

                        activityContent.innerHTML = coffeechatCards;

                        activityContent.classList.add('coffeechat-grid');

                    } else {
                        if (data.posts && data.posts.length > 0) {
                            data.posts.forEach(post => {
                                const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";

                                const postElement = document.createElement('div');
                                postElement.classList.add('activity-card');
                                postElement.innerHTML = `
                                    <div class="card-image" style="background-image: url('${randomImage}');"></div>
                                    <div class="card-content">
                                        <h3><a href="${post.url}"><strong>${post.title}</strong></a></h3>
                                        <span><strong>ì‘ì„±ì:</strong> ${post.writer}</span>
                                        <span>ë‚ ì§œ: ${new Date(post.date).toLocaleDateString()}</span>
                                    </div>
                                `;
                                activityContent.appendChild(postElement);
                            });
                        } else {
                            activityContent.innerHTML = '<p>í•´ë‹¹í•˜ëŠ” ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }

                        activityContent.classList.remove('coffeechat-grid');
                    }
                })
                .catch(error => console.error('Error loading activities:', error));
        }

        function createCoffeeChatCard(coffeechat, category) {
            const randomImage = "{% static 'images/' %}" + "{{ image_files|random }}";
            const options = { month: 'long', day: 'numeric' };
            const date = new Date(coffeechat.created_at).toLocaleDateString('ko-KR', options);
            const time = new Date(coffeechat.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        
            const cardElement = document.createElement('div');
            cardElement.className = 'coffeechat-card';

            // ì¹´í…Œê³ ë¦¬ë³„ë¡œ í‘œì‹œí•  ì´ë¦„ ì„¤ì •
            let displayName;
            if (category === 'history') {
                displayName = coffeechat.sender === '{{ user.username }}' ? coffeechat.receiver : coffeechat.sender;
            } else if (category === 'sent') {
                displayName = coffeechat.receiver;
            } else if (category === 'received') {
                displayName = coffeechat.sender;
            } else {
                displayName = coffeechat.receiver;
            }

            cardElement.innerHTML = `
                <div class="profile-img">
                    ${coffeechat.profile_image ? `<img src="${coffeechat.profile_image}" alt="Profile Image">` : '<i class="fas fa-user"></i>'}
                </div>
                <div class="profile-details">
                    <span class="name">${displayName}</span>
                    ${category !== 'history' ? `<span class="job">${coffeechat.job}</span>` : ''}
                </div>
                <div class="card-content">
                    <span class="request-time">${date} ${time}</span><br>
            `;
        
            if (category === 'sent') {
                cardElement.innerHTML += `<span class="waiting-status">ì„ ë°°ë‹˜ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..</span>`;
            } else if (category === 'received') {
                cardElement.innerHTML += `
                    <span class="waiting-status">í›„ë°°ê°€ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘!</span>
                    <div class="buttons">
                        <form method="post" action="${coffeechat.accept_url}">
                            {% csrf_token %}
                            <button type="submit" class="btn-accept">Accept</button>
                        </form>
                        <form method="post" action="${coffeechat.reject_url}">
                            {% csrf_token %}
                            <button class="btn-reject" type="submit">Reject</button>
                        </form>
                    </div>
                `;
            } else if (category === 'bookmarked') {
                cardElement.innerHTML += `
                    <button onclick="toggleBookmark('${coffeechat.coffeechat_bookmark_profile}', this.closest('.coffeechat-card'))" class="coffeechat-request bookmark-btn">
                        ${coffeechat.bookmarked ? 'ë¶ë§ˆí¬ ì·¨ì†Œ' : 'ë¶ë§ˆí¬ ì¶”ê°€'}
                    </button>
                    <span class="waiting-status">ì»¤í”¼ì±— ê³ ë¯¼ ì¤‘!</span>
                    <div class="buttons">
                        <a href="${coffeechat.detail_url}" class="coffeechat-request">ì»¤í”¼ì±— ìš”ì²­í•˜ê¸°!</a>
                    </div>
                `;
            } else if (category === 'history') {
                cardElement.innerHTML += `
                    <span class="waiting-status">${coffeechat.review_exists ? 'ë¦¬ë·°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.'}</span>
                    <div class="buttons">
                        ${coffeechat.review_exists ? 
                            `<a href="${coffeechat.detail_url}" class="coffeechat-request coffeechat-review">ë˜ ì»¤í”¼ì±— ìš”ì²­í•˜ê¸°!</a>` : 
                            `<a href="${coffeechat.detail_url}" class="coffeechat-request coffeechat-review">ë¦¬ë·° ì‘ì„±í•˜ëŸ¬ ê°€ê¸°!</a>`
                        }
                    </div>
                `;
            }
        
            cardElement.innerHTML += `
                </div>
            `;
        
            return cardElement.outerHTML;
        }

        function addActivityLinkEventListeners() {
            const activityLinks = document.querySelectorAll('.activity-link');
            activityLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentFilter = this.getAttribute('data-filter');
                    activityLinks.forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (currentFilter === 'coffeechat') {
                        document.querySelector('.activity-filter').innerHTML = `
                            <a href="#" class="filter-link active" data-category="requests_sent">Sent</a>
                            <a href="#" class="filter-link" data-category="requests_received">Received</a>
                            <a href="#" class="filter-link" data-category="bookmarked">Interested</a>
                            <a href="#" class="filter-link" data-category="history">History</a>
                        `;
                        addFilterEventListeners();
                        loadActivities(currentFilter, 'requests_sent');
                    } else {
                        document.querySelector('.activity-filter').innerHTML = originalFilterContent;
                        addFilterEventListeners();
                        loadActivities(currentFilter, currentCategory);
                    }
                });
            });
        }

        // ì´ˆê¸° ë¡œë”© ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
        loadActivities(currentFilter, currentCategory);

        addActivityLinkEventListeners();
        addFilterEventListeners();
    });

    function toggleBookmark(url, cardElement) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data.bookmarked) {
                // ë¶ë§ˆí¬ê°€ ì·¨ì†Œë˜ì—ˆìœ¼ë©´ ì¹´ë“œ ì œê±°
                cardElement.remove();
            } else {
                alert('ë¶ë§ˆí¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error toggling bookmark:', error);
        });
    }
</script>
{% endblock %}